import numpy as np
from datetime import datetime
from dateutil.tz import tzlocal
from pynwb import NWBFile
from pynwb import NWBHDF5IO
from pynwb.ecephys import ElectricalSeries
from pynwb.ecephys import LFP
from ecogvis.signal_processing.processing_data import high_gamma_estimation,spectral_decomposition,preprocess_raw_data,make_new_nwb
import unittest


class ProcessingDataTestCase(unittest.TestCase):

    def setUp(self):
        
        start_time = datetime(2017, 4, 3, 11, tzinfo=tzlocal())
        create_date = datetime(2017, 4, 15, 12, tzinfo=tzlocal())
        
        self.nwbfile = NWBFile('my first synthetic recording', 'EXAMPLE_ID', datetime.now(tzlocal()),
                          experimenter='Dr. Bilbo Baggins',
                          lab='Bag End Laboratory',
                          institution='University of Middle Earth at the Shire',
                          experiment_description='I went on an adventure with thirteen dwarves to reclaim vast treasures.',
                          session_id='LONELYMTN')

        device = self.nwbfile.create_device(name='trodes_rig123')

        electrode_name = 'tetrode1'
        description = "an example tetrode"
        location = "somewhere in the hippocampus"

        electrode_group = self.nwbfile.create_electrode_group(electrode_name,
                                                         description=description,
                                                         location=location,
                                                         device=device)

        for idx in [1, 2, 3, 4]:
            self.nwbfile.add_electrode(id=idx,
                                  x=1.0, y=2.0, z=3.0,
                                  imp=float(-idx),
                                  location='CA1', filtering='none',
                                  group=electrode_group)

        electrode_table_region = self.nwbfile.create_electrode_table_region([0, 2], 'the first and third electrodes')

        rate = 5.0
        np.random.seed(1234)
        data_len = 50
        ephys_data = np.array([[0.76711663, 0.70811536],
                               [0.79686718, 0.55776083],
                               [0.96583653, 0.1471569 ],
                               [0.029647  , 0.59389349],
                               [0.1140657 , 0.95080985],
                               [0.32570741, 0.19361869],
                               [0.45781165, 0.92040257],
                               [0.87906916, 0.25261576],
                               [0.34800879, 0.18258873],
                               [0.90179605, 0.70652816],
                               [0.72665846, 0.90008784],
                               [0.7791638 , 0.59915478],
                               [0.29112524, 0.15139526],
                               [0.33517466, 0.65755178],
                               [0.07334254, 0.0550064 ],
                               [0.32319481, 0.5904818 ],
                               [0.85389857, 0.28706243],
                               [0.17306723, 0.13402121],
                               [0.99465383, 0.17949787],
                               [0.31754682, 0.5682914 ],
                               [0.00934857, 0.90064862],
                               [0.97724143, 0.55689468],
                               [0.08477384, 0.33300247],
                               [0.72842868, 0.14243537],
                               [0.55246894, 0.27304326],
                               [0.97449514, 0.66778691],
                               [0.25565329, 0.10831149],
                               [0.77618072, 0.78247799],
                               [0.76160391, 0.91440311],
                               [0.65862278, 0.56836758],
                               [0.20175569, 0.69829638],
                               [0.95219541, 0.88996329],
                               [0.99356736, 0.81870351],
                               [0.54512217, 0.45125405],
                               [0.89055719, 0.97326479],
                               [0.59341133, 0.3660745 ],
                               [0.32309469, 0.87142326],
                               [0.21563406, 0.73494519],
                               [0.36561909, 0.8016026 ],
                               [0.78273559, 0.70135538],
                               [0.62277659, 0.49368265],
                               [0.8405377 , 0.71209699],
                               [0.44390898, 0.03103486],
                               [0.36323976, 0.73072179],
                               [0.47556657, 0.34441697],
                               [0.64088043, 0.12620532],
                               [0.17146526, 0.73708649],
                               [0.12702939, 0.36964987],
                               [0.604334  , 0.10310444],
                               [0.80237418, 0.94555324]])
        ephys_timestamps = np.arange(data_len) / rate

        ephys_ts = ElectricalSeries('preprocessed',
                                    ephys_data,
                                    electrode_table_region,
                                    starting_time=ephys_timestamps[0],
                                    rate=rate,
                                    resolution=0.001,
                                    comments="This data was randomly generated with numpy, using 1234 as the seed",
                                    description="Random numbers generated with numpy.random.rand")
        
        lfp = LFP(ephys_ts)

        ecephys_module = self.nwbfile.create_processing_module(name='ecephys',
                                                       description='preprocessed ecephys data')

        self.nwbfile.processing['ecephys'].add(lfp)


        self.nwbfile_new = NWBFile('my first synthetic recording', 'EXAMPLE_ID', datetime.now(tzlocal()),
                          experimenter='Dr. Bilbo Baggins',
                          lab='Bag End Laboratory',
                          institution='University of Middle Earth at the Shire',
                          experiment_description='I went on an adventure with thirteen dwarves to reclaim vast treasures.',
                          session_id='LONELYMTN')


    def test_high_gamma_estimation(self):
        
        with NWBHDF5IO('ecephys_exmpl_gamma.nwb', 'w') as io:
            io.write(self.nwbfile)

        bands_vals=np.random.rand(2,10)*80+70
        high_gamma_estimation('ecephys_exmpl_gamma.nwb', bands_vals)

        io = NWBHDF5IO('ecephys_exmpl_gamma.nwb', 'r')
        nwbfile_in = io.read()

        high_gamma_data = nwbfile_in.processing['ecephys'].data_interfaces['high_gamma'].data[:]
        high_gamma_data_expected = np.array([[114432.12734375, 106926.36953125],
                                           [104311.51640625,  81010.54921875],
                                           [158632.765625  ,  29015.66972656],
                                           [ 87235.18125   , 109977.53828125],
                                           [ 40694.96054688, 143791.29375   ],
                                           [ 39189.63359375,  24476.98222656],
                                           [ 99898.77265625, 131793.8921875 ],
                                           [116746.00546875,  82916.5953125 ],
                                           [ 56977.66171875,  55775.99765625],
                                           [122025.39375   , 100550.2734375 ],
                                           [110798.99609375, 128243.16484375],
                                           [110201.42265625, 118032.4765625 ],
                                           [ 73953.45234375,  22560.153125  ],
                                           [ 41865.0109375 ,  95126.09453125],
                                           [ 23743.01894531,  19107.33242187],
                                           [ 85232.5453125 ,  83586.396875  ],
                                           [127444.34921875,  60134.734375  ],
                                           [ 17301.87333984,  21913.7796875 ],
                                           [153644.3453125 ,  44228.69492188],
                                           [108004.7703125 , 107790.89140625],
                                           [ 92584.2421875 , 128566.275     ],
                                           [130929.23828125,  82646.0515625 ],
                                           [ 22233.11679688,  52573.65625   ],
                                           [106470.29765625,  17475.74941406],
                                           [ 89623.346875  ,  73826.7125    ],
                                           [129937.9359375 ,  93547.39375   ],
                                           [ 44125.3484375 ,  34720.43320313],
                                           [115818.246875  , 149635.4359375 ],
                                           [114519.30625   , 130255.1828125 ],
                                           [ 87249.54921875,  79923.99765625],
                                           [ 35482.24257812, 102406.0171875 ],
                                           [149241.865625  , 126403.61484375],
                                           [155159.1921875 , 123572.7953125 ],
                                           [ 68665.5015625 ,  63900.49492187],
                                           [133760.8578125 , 139165.9765625 ],
                                           [ 97677.2953125 ,  51414.00859375],
                                           [ 64852.78320312, 129346.84296875],
                                           [ 24607.39375   , 106858.39453125],
                                           [ 72500.85078125, 114212.22421875],
                                           [103932.5       , 117112.81796875],
                                           [ 93862.08828125,  70807.0515625 ],
                                           [112166.11640625, 120027.41953125],
                                           [ 86554.1046875 ,  19128.88339844],
                                           [ 43686.26601562, 101883.1171875 ],
                                           [ 73509.96875   ,  82221.49609375],
                                           [ 85105.04296875,  32386.06582031],
                                           [ 52379.96210938, 107256.77421875],
                                           [ 49256.02304688,  69351.2296875 ],
                                           [106910.11328125,  53854.99570313],
                                           [108948.4109375 , 138653.6015625 ]])
        
        np.testing.assert_almost_equal(high_gamma_data,high_gamma_data_expected)

    def test_spectral_decomposition(self):
        
        with NWBHDF5IO('ecephys_exmpl_decomp.nwb', 'w') as io:
            io.write(self.nwbfile)

        bands_vals=np.random.rand(2,10)*80+70
        spectral_decomposition('ecephys_exmpl_decomp.nwb', bands_vals)
        
        io = NWBHDF5IO('ecephys_exmpl_decomp.nwb', 'r')
        nwbfile_in = io.read()

        decomposition_data = nwbfile_in.processing['ecephys'].data_interfaces['DecompositionSeries'].data[:]
        decomposition_data_expected = np.array([[[114617.296875  , 114486.0078125 , 114848.0546875 ,
                                             114675.953125  , 114086.171875  , 114826.0546875 ,
                                             114754.0390625 , 112567.6015625 , 114651.6171875 ,
                                             114808.4765625 ],
                                            [107103.5859375 , 106978.0390625 , 107322.3828125 ,
                                             107158.4609375 , 106597.3828125 , 107301.71875   ,
                                             107233.3046875 , 105149.265625  , 107135.1796875 ,
                                             107284.375     ]],

                                           [[104542.0625    , 104378.6796875 , 104826.75      ,
                                             104613.4453125 , 103883.40625   , 104799.859375  ,
                                             104710.84375   , 101999.6953125 , 104583.140625  ,
                                             104777.28125   ],
                                            [ 81147.546875  ,  81050.4140625 ,  81318.34375   ,
                                              81190.9921875 ,  80754.515625  ,  81302.0625    ,
                                              81248.7578125 ,  79630.8046875 ,  81172.984375  ,
                                              81289.0703125 ]],

                                           [[158760.78125   , 158670.578125  , 158918.875     ,
                                             158800.859375  , 158395.78125   , 158903.84375   ,
                                             158854.5       , 157346.59375   , 158784.15625   ,
                                             158891.6875    ],
                                            [ 29102.65429688,  29037.88867188,  29218.96875   ,
                                              29132.79296875,  28841.1015625 ,  29207.6640625 ,
                                              29171.3984375 ,  28124.09765625,  29120.74609375,
                                              29199.38476562]],

                                           [[ 87250.3984375 ,  87238.7890625 ,  87270.2734375 ,
                                              87255.125     ,  87204.71875   ,  87268.4453125 ,
                                              87262.1640625 ,  87082.296875  ,  87252.953125  ,
                                              87266.6484375 ],
                                            [110059.9453125 , 110001.0390625 , 110163.3046875 ,
                                             110086.0859375 , 109822.2578125 , 110153.4765625 ,
                                             110121.1796875 , 109147.4453125 , 110075.15625   ,
                                             110145.4921875 ]],

                                           [[ 40677.609375  ,  40688.921875  ,  40660.45703125,
                                              40674.203125  ,  40721.69921875,  40661.8203125 ,
                                              40667.31640625,  40857.2578125 ,  40676.30078125,
                                              40664.01953125],
                                            [143883.140625  , 143818.203125  , 143998.140625  ,
                                             143912.75      , 143619.421875  , 143987.09375   ,
                                             143951.265625  , 142863.53125   , 143900.71875   ,
                                             143978.671875  ]],

                                           [[ 39313.33984375,  39225.09765625,  39468.546875  ,
                                              39352.76171875,  38956.734375  ,  39453.74609375,
                                              39405.29296875,  37942.51171875,  39336.39453125,
                                              39441.91015625],
                                            [ 24713.640625  ,  24545.43945312,  25007.27539062,
                                              24787.41992188,  24035.4765625 ,  24979.49609375,
                                              24887.69726562,  22100.8046875 ,  24756.22070312,
                                              24956.3515625 ]],

                                           [[100002.8828125 ,  99928.78125   , 100133.0078125 ,
                                             100035.8671875 ,  99703.484375  , 100120.6171875 ,
                                             100079.984375  ,  98850.34375   , 100022.125     ,
                                             100110.6328125 ],
                                            [131870.265625  , 131816.25      , 131966.625     ,
                                             131895.34375   , 131650.25      , 131957.296875  ,
                                             131927.3125    , 131019.75      , 131885.34375   ,
                                             131950.484375  ]],

                                           [[116872.1015625 , 116782.671875  , 117029.625     ,
                                             116912.2734375 , 116510.015625  , 117014.5703125 ,
                                             116965.4296875 , 115474.9765625 , 116895.6953125 ,
                                             117002.6953125 ],
                                            [ 82944.453125  ,  82923.578125  ,  82981.71875   ,
                                              82954.        ,  82860.5       ,  82978.125     ,
                                              82966.4765625 ,  82631.6171875 ,  82950.109375  ,
                                              82975.375     ]],

                                           [[ 57186.56640625,  57038.0390625 ,  57446.73828125,
                                              57252.28515625,  56586.92578125,  57422.03125   ,
                                              57340.75390625,  54876.6953125 ,  57224.73828125,
                                              57401.84375   ],
                                            [ 55797.07421875,  55780.6328125 ,  55827.8203125 ,
                                              55805.421875  ,  55730.19921875,  55824.71875   ,
                                              55815.1796875 ,  55553.68359375,  55802.35546875,
                                              55822.890625  ]],

                                           [[122179.578125  , 122070.3828125 , 122371.640625  ,
                                             122228.4609375 , 121737.5859375 , 122353.3125    ,
                                             122293.3828125 , 120472.625     , 122208.2265625 ,
                                             122338.7421875 ],
                                            [100709.890625  , 100597.0078125 , 100906.890625  ,
                                             100759.4375    , 100254.3125    , 100888.25      ,
                                             100826.6875    ,  98948.984375  , 100738.515625  ,
                                             100872.7578125 ]],

                                           [[111004.203125  , 110858.9453125 , 111257.671875  ,
                                             111067.921875  , 110418.1171875 , 111233.6953125 ,
                                             111154.46875   , 108740.2109375 , 111040.9921875 ,
                                             111213.734375  ],
                                            [128413.328125  , 128293.0390625 , 128622.9921875 ,
                                             128465.96875   , 127928.0546875 , 128603.1796875 ,
                                             128537.640625  , 126537.171875  , 128443.6640625 ,
                                             128586.609375  ]],

                                           [[110364.5078125 , 110249.078125  , 110566.71875   ,
                                             110415.6640625 , 109898.        , 110547.5078125 ,
                                             110484.359375  , 108562.234375  , 110394.2734375 ,
                                             110531.8828125 ],
                                            [118127.28125   , 118059.953125  , 118246.0234375 ,
                                             118157.609375  , 117854.6171875 , 118234.6640625 ,
                                             118197.625     , 117076.1171875 , 118145.125     ,
                                             118225.75      ]],

                                           [[ 74073.4375    ,  73988.0078125 ,  74223.2578125 ,
                                              74111.3359375 ,  73728.4921875 ,  74209.015625  ,
                                              74162.21875   ,  72745.828125  ,  74095.4921875 ,
                                              74197.4375    ],
                                            [ 22709.97460938,  22600.88867188,  22901.94335938,
                                              22758.49414062,  22270.98046875,  22883.65429688,
                                              22823.63867188,  21044.90234375,  22738.22460938,
                                              22868.83007812]],

                                           [[ 41966.58984375,  41894.28125   ,  42094.3046875 ,
                                              41999.265625  ,  41673.734375  ,  42082.0703125 ,
                                              42042.2421875 ,  40839.22265625,  41985.859375  ,
                                              42072.5390625 ],
                                            [ 95182.1796875 ,  95142.4609375 ,  95253.84375   ,
                                              95201.140625  ,  95019.671875  ,  95246.8203125 ,
                                              95224.578125  ,  94554.421875  ,  95193.7890625 ,
                                              95242.0390625 ]],

                                           [[ 23771.328125  ,  23749.13085938,  23813.07421875,
                                              23782.74023438,  23680.88867188,  23808.84179688,
                                              23795.90429688,  23443.24414062,  23778.60351562,
                                              23806.43359375],
                                            [ 19185.515625  ,  19125.25195312,  19292.16796875,
                                              19212.27539062,  18945.38671875,  19281.98632812,
                                              19248.54492188,  18307.54296875,  19201.01953125,
                                              19273.6328125 ]],

                                           [[ 85284.265625  ,  85247.        ,  85349.34375   ,
                                              85300.5625    ,  85134.46875   ,  85343.1953125 ,
                                              85322.828125  ,  84712.125     ,  85293.640625  ,
                                              85338.0234375 ],
                                            [ 83637.5546875 ,  83601.1953125 ,  83702.796875  ,
                                              83654.65625   ,  83489.2578125 ,  83696.4453125 ,
                                              83676.171875  ,  83066.0234375 ,  83647.921875  ,
                                              83691.9453125 ]],

                                           [[127513.3359375 , 127464.5703125 , 127600.4453125 ,
                                             127536.0546875 , 127314.578125  , 127591.9921875 ,
                                             127564.9140625 , 126744.6875    , 127527.03125   ,
                                             127585.8828125 ],
                                            [ 60189.546875  ,  60150.15625   ,  60258.734375  ,
                                              60207.04296875,  60030.73046875,  60252.1484375 ,
                                              60230.53125   ,  59581.91796875,  60199.73046875,
                                              60246.8046875 ]],

                                           [[ 17533.41601562,  17367.984375  ,  17821.8203125 ,
                                              17605.61914062,  16867.51171875,  17794.5859375 ,
                                              17704.36328125,  14976.88574219,  17574.91601562,
                                              17771.63085938],
                                            [ 21968.08984375,  21928.48046875,  22039.79296875,
                                              21987.00195312,  21806.87304688,  22032.7578125 ,
                                              22010.47265625,  21356.734375  ,  21979.65234375,
                                              22027.94140625]],

                                           [[153698.0625    , 153660.21875   , 153766.09375   ,
                                             153715.984375  , 153543.28125   , 153759.453125  ,
                                             153738.328125  , 153098.21875   , 153708.984375  ,
                                             153754.828125  ],
                                            [ 44348.2734375 ,  44263.34765625,  44496.57421875,
                                              44385.5625    ,  44005.76953125,  44482.5390625 ,
                                              44436.18359375,  43028.01171875,  44369.8125    ,
                                              44470.875     ]],

                                           [[107953.4140625 , 107989.0078125 , 107892.7265625 ,
                                             107938.625     , 108096.3984375 , 107898.328125  ,
                                             107917.359375  , 108513.078125  , 107945.21875   ,
                                             107903.546875  ],
                                            [107917.4453125 , 107827.84375   , 108073.8515625 ,
                                             107956.78125   , 107555.8828125 , 108059.0546875 ,
                                             108010.171875  , 106520.953125  , 107940.171875  ,
                                             108046.7578125 ]],

                                           [[ 92517.5078125 ,  92563.8515625 ,  92438.5234375 ,
                                              92498.2890625 ,  92703.546875  ,  92445.8125    ,
                                              92470.5859375 ,  93244.8046875 ,  92506.875     ,
                                              92452.625     ],
                                            [128713.953125  , 128609.6796875 , 128895.9609375 ,
                                             128759.765625  , 128292.9296875 , 128878.734375  ,
                                             128821.859375  , 127084.9765625 , 128740.4375    ,
                                             128864.453125  ]],

                                           [[130982.6796875 , 130944.7890625 , 131050.984375  ,
                                             131000.7265625 , 130827.75      , 131044.296875  ,
                                             131023.09375   , 130384.6328125 , 130993.7109375 ,
                                             131039.71875   ],
                                            [ 82797.28125   ,  82690.0703125 ,  82984.3359375 ,
                                              82844.2734375 ,  82364.875     ,  82966.6484375 ,
                                              82908.171875  ,  81128.578125  ,  82824.390625  ,
                                              82951.890625  ]],

                                           [[ 22414.328125  ,  22282.98828125,  22645.05664062,
                                              22472.5625    ,  21885.6171875 ,  22623.109375  ,
                                              22550.97460938,  20403.16015625,  22448.16601562,
                                              22605.20507812],
                                            [ 52676.65234375,  52603.47265625,  52805.58984375,
                                              52709.52734375,  52380.4453125 ,  52793.26953125,
                                              52753.04296875,  51535.05859375,  52695.9609375 ,
                                              52783.54296875]],

                                           [[106585.1015625 , 106503.6953125 , 106729.59375   ,
                                             106622.390625  , 106254.421875  , 106715.6796875 ,
                                             106670.6796875 , 105308.921875  , 106607.3125    ,
                                             106705.1796875 ],
                                            [ 17574.67382812,  17503.72851562,  17700.84960938,
                                              17607.23046875,  17286.98242188,  17688.6796875 ,
                                              17649.3671875 ,  16472.38476562,  17594.07421875,
                                              17679.5234375 ]],

                                           [[ 89841.609375  ,  89687.        ,  90110.859375  ,
                                              89909.0625    ,  89218.390625  ,  90085.453125  ,
                                              90001.2578125 ,  87435.40625   ,  89880.390625  ,
                                              90064.0390625 ],
                                            [ 73912.234375  ,  73851.3359375 ,  74018.96875   ,
                                              73939.203125  ,  73666.40625   ,  74008.828125  ,
                                              73975.484375  ,  72966.203125  ,  73927.90625   ,
                                              74000.5546875 ]],

                                           [[130067.0703125 , 129975.640625  , 130228.828125  ,
                                             130108.625     , 129696.0546875 , 130213.296875  ,
                                             130162.890625  , 128633.890625  , 130091.6875    ,
                                             130201.375     ],
                                            [ 93639.2421875 ,  93574.015625  ,  93754.9921875 ,
                                              93669.09375   ,  93374.3984375 ,  93743.8515625 ,
                                              93707.796875  ,  92618.125     ,  93657.        ,
                                              93735.421875  ]],

                                           [[ 44317.23046875,  44179.5078125 ,  44558.93359375,
                                              44378.296875  ,  43761.9453125 ,  44535.953125  ,
                                              44460.421875  ,  42191.2265625 ,  44352.734375  ,
                                              44517.234375  ],
                                            [ 34893.8828125 ,  34768.875     ,  35112.75      ,
                                              34948.90234375,  34390.81640625,  35092.        ,
                                              35023.546875  ,  32973.06640625,  34925.6875    ,
                                              35074.8046875 ]],

                                           [[115943.078125  , 115854.3359375 , 116100.1015625 ,
                                             115983.3828125 , 115583.28125   , 116085.03125   ,
                                             116036.0859375 , 114556.8125    , 115966.9296875 ,
                                             116073.4296875 ],
                                            [149762.703125  , 149672.703125  , 149920.90625   ,
                                             149802.953125  , 149398.375     , 149905.828125  ,
                                             149856.453125  , 148354.34375   , 149786.28125   ,
                                             149893.8125    ]],

                                           [[114704.3125    , 114573.2890625 , 114933.1640625 ,
                                             114761.9296875 , 114175.5       , 114911.4921875 ,
                                             114839.9765625 , 112662.2109375 , 114737.6328125 ,
                                             114893.5546875 ],
                                            [130433.8984375 , 130307.078125  , 130655.90625   ,
                                             130489.953125  , 129921.8046875 , 130634.8359375 ,
                                             130565.484375  , 128458.859375  , 130466.4296875 ,
                                             130617.578125  ]],

                                           [[ 87400.578125  ,  87293.3515625 ,  87589.6875    ,
                                              87448.890625  ,  86966.3125    ,  87571.6015625 ,
                                              87512.6171875 ,  85726.0234375 ,  87429.015625  ,
                                              87557.4140625 ],
                                            [ 80134.59375   ,  79984.9296875 ,  80397.6875    ,
                                              80201.4296875 ,  79529.4140625 ,  80372.609375  ,
                                              80290.484375  ,  77802.6015625 ,  80173.6875    ,
                                              80352.5390625 ]],

                                           [[ 35690.89453125,  35542.4765625 ,  35951.64453125,
                                              35757.0625    ,  35091.03125   ,  35926.8046875 ,
                                              35845.39453125,  33380.73046875,  35729.5390625 ,
                                              35906.84765625],
                                            [102604.6484375 , 102463.7421875 , 102852.3125    ,
                                             102667.59375   , 102034.6796875 , 102828.7109375 ,
                                             102751.40625   , 100405.78125   , 102641.46875   ,
                                             102809.828125  ]],

                                           [[149377.171875  , 149281.203125  , 149545.625     ,
                                             149419.890625  , 148989.1875    , 149529.59375   ,
                                             149477.        , 147880.203125  , 149402.109375  ,
                                             149516.671875  ],
                                            [126608.765625  , 126463.4140625 , 126863.078125  ,
                                             126672.953125  , 126021.7578125 , 126838.9609375 ,
                                             126759.5078125 , 124342.5390625 , 126646.0078125 ,
                                             126819.1640625 ]],

                                           [[155320.53125   , 155206.171875  , 155521.375     ,
                                             155371.515625  , 154858.015625  , 155502.25      ,
                                             155439.546875  , 153535.328125  , 155350.3125    ,
                                             155486.875     ],
                                            [123725.328125  , 123616.875     , 123916.859375  ,
                                             123774.3359375 , 123285.9921875 , 123898.515625  ,
                                             123838.78125   , 122032.8046875 , 123754.234375  ,
                                             123884.2265625 ]],

                                           [[ 68918.1328125 ,  68738.6953125 ,  69232.140625  ,
                                              68997.3515625 ,  68193.828125  ,  69202.359375  ,
                                              69104.25      ,  66126.2890625 ,  68964.0703125 ,
                                              69177.8984375 ],
                                            [ 64116.609375  ,  63962.26171875,  64387.06640625,
                                              64184.87109375,  63494.01953125,  64361.3828125 ,
                                              64276.8671875 ,  61725.27734375,  64156.234375  ,
                                              64340.359375  ]],

                                           [[133915.78125   , 133806.109375  , 134108.9375    ,
                                             133965.0625    , 133471.5625    , 134090.484375  ,
                                             134030.234375  , 132199.734375  , 133944.734375  ,
                                             134075.9375    ],
                                            [139290.890625  , 139202.421875  , 139448.03125   ,
                                             139331.515625  , 138931.3125    , 139432.875     ,
                                             139383.953125  , 137902.109375  , 139315.125     ,
                                             139421.53125   ]],

                                           [[ 97851.0859375 ,  97727.8515625 ,  98066.171875  ,
                                              97905.1484375 ,  97354.0078125 ,  98045.828125  ,
                                              97978.59375   ,  95933.09375   ,  97882.2890625 ,
                                              98028.8828125 ],
                                            [ 51638.5703125 ,  51478.11328125,  51919.62109375,
                                              51709.453125  ,  50991.50390625,  51892.9453125 ,
                                              51805.109375  ,  49154.03515625,  51679.6796875 ,
                                              51871.0546875 ]],

                                           [[ 64976.17578125,  64888.53125   ,  65130.69921875,
                                              65015.62109375,  64621.30078125,  65115.921875  ,
                                              65067.71875   ,  63608.1796875 ,  64999.375     ,
                                              65104.30859375],
                                            [129480.15625   , 129385.4375    , 129648.0390625 ,
                                             129523.3671875 , 129095.8125    , 129631.8984375 ,
                                             129579.5859375 , 127998.71875   , 129505.8125    ,
                                             129619.6015625 ]],

                                           [[ 24721.80273438,  24639.79296875,  24867.24804688,
                                              24759.17382812,  24389.60351562,  24853.25976562,
                                              24807.91601562,  23448.61328125,  24743.96484375,
                                              24842.5625    ],
                                            [107061.8515625 , 106917.234375  , 107315.234375  ,
                                             107125.8828125 , 106477.8984375 , 107291.171875  ,
                                             107212.0234375 , 104812.0546875 , 107099.0625    ,
                                             107271.53125   ]],

                                           [[ 72607.0625    ,  72531.4296875 ,  72740.0078125 ,
                                              72640.8125    ,  72301.3828125 ,  72727.3359375 ,
                                              72685.828125  ,  71430.6796875 ,  72626.7890625 ,
                                              72717.1796875 ],
                                            [114398.0078125 , 114266.        , 114629.921875  ,
                                             114456.875     , 113864.3359375 , 114607.828125  ,
                                             114535.4296875 , 112341.3515625 , 114432.3984375 ,
                                             114590.09375   ]],

                                           [[104087.21875   , 103977.6953125 , 104279.203125  ,
                                             104135.8359375 , 103644.46875   , 104260.953125  ,
                                             104201.0078125 , 102376.9296875 , 104115.53125   ,
                                             104246.15625   ],
                                            [117260.9921875 , 117155.6328125 , 117446.8359375 ,
                                             117308.4453125 , 116834.40625   , 117429.0546875 ,
                                             117371.0859375 , 115617.7109375 , 117288.9140625 ,
                                             117415.1015625 ]],

                                           [[ 94057.4609375 ,  93919.03125   ,  94299.5625    ,
                                              94118.53125   ,  93498.515625  ,  94276.609375  ,
                                              94200.96875   ,  91899.6015625 ,  94092.8671875 ,
                                              94257.734375  ],
                                            [ 71002.0078125 ,  70863.09375   ,  71245.2421875 ,
                                              71063.375     ,  70441.546875  ,  71222.1640625 ,
                                              71146.15625   ,  68846.09375   ,  71037.609375  ,
                                              71203.2265625 ]],

                                           [[112330.8515625 , 112214.2421875 , 112535.1953125 ,
                                             112382.5703125 , 111859.5234375 , 112515.7734375 ,
                                             112451.96875   , 110510.0703125 , 112360.9609375 ,
                                             112500.0078125 ],
                                            [120118.9453125 , 120054.171875  , 120234.0859375 ,
                                             120148.75      , 119855.546875  , 120222.9765625 ,
                                             120187.1328125 , 119101.140625  , 120136.75      ,
                                             120214.6953125 ]],

                                           [[ 86687.7578125 ,  86592.7578125 ,  86854.5859375 ,
                                              86730.0703125 ,  86303.8046875 ,  86838.703125  ,
                                              86786.609375  ,  85208.390625  ,  86712.453125  ,
                                              86825.9140625 ],
                                            [ 19218.1953125 ,  19147.984375  ,  19342.8671875 ,
                                              19249.48046875,  18939.14648438,  19330.9375    ,
                                              19291.82226562,  18210.8515625 ,  19236.34765625,
                                              19321.20117188]],

                                           [[ 43832.3671875 ,  43728.375     ,  44015.71875   ,
                                              43879.14453125,  43411.4921875 ,  43998.1875    ,
                                              43940.984375  ,  42212.13671875,  43859.8671875 ,
                                              43984.38671875],
                                            [101950.578125  , 101902.671875  , 102035.890625  ,
                                             101972.703125  , 101755.78125   , 102027.6484375 ,
                                             102001.09375   , 101199.4296875 , 101963.828125  ,
                                             102021.546875  ]],

                                           [[ 73639.2578125 ,  73547.5625    ,  73800.359375  ,
                                              73680.1796875 ,  73268.3984375 ,  73785.0078125 ,
                                              73734.7265625 ,  72208.3046875 ,  73663.1796875 ,
                                              73772.7109375 ],
                                            [ 82278.609375  ,  82237.65625   ,  82350.9765625 ,
                                              82297.09375   ,  82112.9921875 ,  82344.0390625 ,
                                              82321.4609375 ,  81644.0078125 ,  82289.5       ,
                                              82338.625     ]],

                                           [[ 85226.90625   ,  85140.6953125 ,  85377.8125    ,
                                              85265.0390625 ,  84878.5546875 ,  85363.4921875 ,
                                              85316.359375  ,  83880.734375  ,  85249.0546875 ,
                                              85351.78125   ],
                                            [ 32416.81445312,  32392.0703125 ,  32461.36914062,
                                              32428.15625   ,  32318.44140625,  32457.04882812,
                                              32443.0859375 ,  32066.41992188,  32423.52148438,
                                              32453.73046875]],

                                           [[ 52421.3828125 ,  52391.21484375,  52475.328125  ,
                                              52435.3515625 ,  52299.20703125,  52470.1015625 ,
                                              52453.29296875,  51957.75      ,  52429.75      ,
                                              52466.2421875 ],
                                            [107343.4375    , 107282.2890625 , 107450.890625  ,
                                             107370.78125   , 107095.8046875 , 107440.6484375 ,
                                             107407.1171875 , 106384.828125  , 107359.453125  ,
                                             107432.4921875 ]],

                                           [[ 49289.08984375,  49264.3203125 ,  49332.95703125,
                                              49300.1875    ,  49189.8125    ,  49328.7578125 ,
                                              49315.02734375,  48919.109375  ,  49295.57421875,
                                              49325.39453125],
                                            [ 69407.6171875 ,  69366.828125  ,  69479.984375  ,
                                              69426.171875  ,  69242.7109375 ,  69473.03125   ,
                                              69450.453125  ,  68779.2265625 ,  69418.59375   ,
                                              69467.6796875 ]],

                                           [[107046.53125   , 106950.0546875 , 107215.546875  ,
                                             107089.3046875 , 106656.546875  , 107199.484375  ,
                                             107146.7109375 , 105539.09375   , 107071.421875  ,
                                             107186.4375    ],
                                            [ 53900.2734375 ,  53866.16796875,  53960.3125    ,
                                              53915.29296875,  53764.0859375 ,  53954.60546875,
                                              53935.78515625,  53394.6484375 ,  53908.93359375,
                                              53949.8515625 ]],

                                           [[109147.5546875 , 109006.59375   , 109393.609375  ,
                                             109209.453125  , 108578.7109375 , 109370.328125  ,
                                             109293.4296875 , 106950.125     , 109183.3125    ,
                                             109350.9921875 ],
                                            [138774.28125   , 138689.15625   , 138923.515625  ,
                                             138812.109375  , 138429.875     , 138909.3125    ,
                                             138862.734375  , 137440.828125  , 138796.34375   ,
                                             138897.859375  ]]])
        np.testing.assert_almost_equal(decomposition_data,decomposition_data_expected)

    def test_preprocess_raw_data(self):
        
        with NWBHDF5IO('ecephys_exmpl_raw.nwb', 'w') as io:
            io.write(self.nwbfile)
 
        config = {'CAR':16,'Notch':60,'Downsample':400}
        preprocess_raw_data('ecephys_exmpl_raw.nwb', config)
        
        io = NWBHDF5IO('ecephys_exmpl_raw.nwb', 'r')
        nwbfile_in = io.read()

        raw_data = nwbfile_in.processing['ecephys'].data_interfaces['LFP'].electrical_series['preprocessed'].data[:]
        raw_data_expected = np.array([[0.76711663, 0.70811536],
                                       [0.79686718, 0.55776083],
                                       [0.96583653, 0.1471569 ],
                                       [0.029647  , 0.59389349],
                                       [0.1140657 , 0.95080985],
                                       [0.32570741, 0.19361869],
                                       [0.45781165, 0.92040257],
                                       [0.87906916, 0.25261576],
                                       [0.34800879, 0.18258873],
                                       [0.90179605, 0.70652816],
                                       [0.72665846, 0.90008784],
                                       [0.7791638 , 0.59915478],
                                       [0.29112524, 0.15139526],
                                       [0.33517466, 0.65755178],
                                       [0.07334254, 0.0550064 ],
                                       [0.32319481, 0.5904818 ],
                                       [0.85389857, 0.28706243],
                                       [0.17306723, 0.13402121],
                                       [0.99465383, 0.17949787],
                                       [0.31754682, 0.5682914 ],
                                       [0.00934857, 0.90064862],
                                       [0.97724143, 0.55689468],
                                       [0.08477384, 0.33300247],
                                       [0.72842868, 0.14243537],
                                       [0.55246894, 0.27304326],
                                       [0.97449514, 0.66778691],
                                       [0.25565329, 0.10831149],
                                       [0.77618072, 0.78247799],
                                       [0.76160391, 0.91440311],
                                       [0.65862278, 0.56836758],
                                       [0.20175569, 0.69829638],
                                       [0.95219541, 0.88996329],
                                       [0.99356736, 0.81870351],
                                       [0.54512217, 0.45125405],
                                       [0.89055719, 0.97326479],
                                       [0.59341133, 0.3660745 ],
                                       [0.32309469, 0.87142326],
                                       [0.21563406, 0.73494519],
                                       [0.36561909, 0.8016026 ],
                                       [0.78273559, 0.70135538],
                                       [0.62277659, 0.49368265],
                                       [0.8405377 , 0.71209699],
                                       [0.44390898, 0.03103486],
                                       [0.36323976, 0.73072179],
                                       [0.47556657, 0.34441697],
                                       [0.64088043, 0.12620532],
                                       [0.17146526, 0.73708649],
                                       [0.12702939, 0.36964987],
                                       [0.604334  , 0.10310444],
                                       [0.80237418, 0.94555324]])
        np.testing.assert_almost_equal(raw_data,raw_data_expected)
        
    def test_make_new_nwb(self):
        
        with NWBHDF5IO('ecephys_exmpl_make.nwb', 'w') as io:
            io.write(self.nwbfile)
        
        with NWBHDF5IO('new_ecephys_example.nwb', 'w') as io:
                io.write(self.nwbfile_new)

        cp_objs = {
        'institution': True,
        'lab': True,
        'session':True,
        'devices':True,
        'electrode_groups':True,
        'electrodes':True,
        'intervals':True,
        'stimulus':True,
        'acquisition':'default',
        'ecephys':'default'}
        make_new_nwb('ecephys_exmpl_make.nwb','new_ecephys_example.nwb',cp_objs=cp_objs)
        
        io = NWBHDF5IO('ecephys_exmpl_make.nwb', 'r')
        nwbfile_in = io.read()

        io = NWBHDF5IO('new_ecephys_example.nwb', 'r')
        new_nwbfile_in = io.read()
        
        assert (set(cp_objs.keys()) & set(new_nwbfile_in.fields.keys())).issubset(set(nwbfile_in.fields.keys()))
